(window.webpackJsonp=window.webpackJsonp||[]).push([[244],{314:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return l})),n.d(t,"default",(function(){return u}));var a=n(3),r=n(7),i=(n(0),n(703)),o={title:"Post build updating with SQL triggers"},s={unversionedId:"database/database-building/post-build-updating-with-sql-triggers",id:"version-4.0.0/database/database-building/post-build-updating-with-sql-triggers",isDocsHomePage:!1,title:"Post build updating with SQL triggers",description:"Warning",source:"@site/versioned_docs/version-4.0.0/database/database-building/post-build-updating-with-sql-triggers.md",slug:"/database/database-building/post-build-updating-with-sql-triggers",permalink:"/im-docs/docs/4.0.0/database/database-building/post-build-updating-with-sql-triggers",editUrl:"https://github.com/intermine/im-docs/edit/master/versioned_docs/version-4.0.0/database/database-building/post-build-updating-with-sql-triggers.md",version:"4.0.0",sidebar:"version-4.0.0/someSidebar",previous:{title:"Post processing",permalink:"/im-docs/docs/4.0.0/database/database-building/post-processing/index"},next:{title:"Debugging",permalink:"/im-docs/docs/4.0.0/database/database-building/debugging"}},l=[{value:"Requirements",id:"requirements",children:[]},{value:"Procedure",id:"procedure",children:[{value:"Adding triggers",id:"adding-triggers",children:[]},{value:"Removing triggers",id:"removing-triggers",children:[]},{value:"What can&#39;t be done (yet)",id:"what-cant-be-done-yet",children:[]}]}],c={toc:l};function u(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(a.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Warning"),"\nPlease note this is an experimental facility and is subject to a number of caveats ","(","see below",")",". Please always take a backup of your database before trying."),Object(i.b)("p",null,"We very much welcome feedback, discussion and additional patches for this. Many thanks to Joe Carlson of the DOE Joint Genome Institute for the idea and implementation!"),Object(i.b)("h2",{id:"requirements"},"Requirements"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"InterMine release ",">"," 1.7.3"),Object(i.b)("li",{parentName:"ol"},"plpgsql must be installed in your postgres ","(","select ","*"," from pg","_","language where lanname='plpgsql';",")",". Check the postgreSQL manuals for instructions on installing languages if needed."),Object(i.b)("li",{parentName:"ol"},"Backup the database prior to making changes, especially if there are changes that affect foreign keys.")),Object(i.b)("h2",{id:"procedure"},"Procedure"),Object(i.b)("p",null,"Traditionally, once the data for a mine has been built, it can only be updated by a complete rebuild. However, sometimes, after a long loading process, you see that something is not right: perhaps a minor issue such as a typo in a name, or perhaps something more major such as errors in an entire dataset. Rather than rebuilding the entire mine from scratch, a process that can take many hours or even many days, you'd like to make changes to your existing data build."),Object(i.b)("p",null,"Making such updates requires coordinated changes to a number of InterMine tables. For instance, to update a value, one needs to at least:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Update the value in InterMine's table for that object ","(","e.g. the length column in the Gene table",")","."),Object(i.b)("li",{parentName:"ol"},"Update the value in InterMine's tables for all the ancestor classes of that object ","(","e.g. the length column in the SequenceFeature table",")","."),Object(i.b)("li",{parentName:"ol"},"Update the serialized object in the object column of the intermineobject table.")),Object(i.b)("p",null,"One way to do this is by installing triggers into the PostgreSQL database that will co-ordinate these updates. InterMine can now generate such triggers if you invoke the ant generate-update-triggers in your mine's dbmodel/ directory like so:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"cd $MINE\n./gradlew generateUpdateTriggers\n")),Object(i.b)("p",null,"This will generate two SQL files in the dbmodel/build/resources/main/ subdirectory"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-bash"}),"add-update-triggers.sql\nremove-update-triggers.sql\n")),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"add-update-triggers.sql")," contains the SQL triggers necessary to co-ordinate table updates. ",Object(i.b)("inlineCode",{parentName:"p"},"remove-update-triggers.sql")," contains the removal code. All the triggers have a prefix of ",Object(i.b)("inlineCode",{parentName:"p"},"im_"),"."),Object(i.b)("h3",{id:"adding-triggers"},"Adding triggers"),Object(i.b)("p",null,"To add the triggers just execute add-update-triggers.sql using psql like so"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"psql -f add-update-triggers.sql MINE-NAME\n")),Object(i.b)("p",null,"You can now do basic create/update/delete operations such as:"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"UPDATE organism set genus='Homo' where genus='Homer';"),Object(i.b)("li",{parentName:"ul"},"DELETE FROM organism where commonname='yeti';")),Object(i.b)("p",null,"The triggers propagate the operations to the superclasses and InterMineObjec tables."),Object(i.b)("p",null,"Tables have default values supplied for id and class, so you can create new records"),Object(i.b)("ul",null,Object(i.b)("li",{parentName:"ul"},"INSERT INTO organism ","(","genus,species",")"," values ","(","'Hello','world'",")",";")),Object(i.b)("p",null,"The id is supplied from a sequence im","_","post","_","build","_","insert","_","serial which is initially set to the maximum id of InterMineObject."),Object(i.b)("p",null,"Once you've completed update operations, you must remove the triggers. Failure to do so may cause interference with InterMine's run time serial use, though this point needs to be clarified."),Object(i.b)("h3",{id:"removing-triggers"},"Removing triggers"),Object(i.b)("p",null,"You can remove triggers by executing the ",Object(i.b)("inlineCode",{parentName:"p"},"remove-update-triggers.sql")," SQL:"),Object(i.b)("pre",null,Object(i.b)("code",Object(a.a)({parentName:"pre"},{className:"language-text"}),"psql -f remove-update-triggers.sql MINE-NAME\n")),Object(i.b)("h3",{id:"what-cant-be-done-yet"},"What can't be done ","(","yet",")"),Object(i.b)("p",null,"Please note that there are a number of database changes that the triggers CANNOT handle as of yet:"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Foreign key constraints are not enforced. If you delete a gene, there may still be entries in the genesproteins table or a reference to this from the geneid field in the mrna table. Foreign keys are enforced at the application layer. This means whoever is doing the update needs to keep things straight. ","(","This is possible to implement. It may be done in the future.",")"),Object(i.b)("li",{parentName:"ol"},"The tracker table is not updated. If you do an integration step after manual operations and the integrator is trying to update a column value that you inserted manually, the integration step will fail."),Object(i.b)("li",{parentName:"ol"},"The clob table cannot be manipulated. Again, this may also be changed in the future."),Object(i.b)("li",{parentName:"ol"},"If the id field in InterMineObject has exceeded 2^31 and gone negative, the sequence im","_","post","_","build","_","insert","_","serial cannot be used in INSERT operations without ","(","probably",")"," colliding with another object. The value of the serial must be set manually in this case.")))}u.isMDXComponent=!0},703:function(e,t,n){"use strict";n.d(t,"a",(function(){return d})),n.d(t,"b",(function(){return g}));var a=n(0),r=n.n(a);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=r.a.createContext({}),u=function(e){var t=r.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},d=function(e){var t=u(e.components);return r.a.createElement(c.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},p=r.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,i=e.originalType,o=e.parentName,c=l(e,["components","mdxType","originalType","parentName"]),d=u(n),p=a,g=d["".concat(o,".").concat(p)]||d[p]||b[p]||i;return n?r.a.createElement(g,s(s({ref:t},c),{},{components:n})):r.a.createElement(g,s({ref:t},c))}));function g(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var i=n.length,o=new Array(i);o[0]=p;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:a,o[1]=s;for(var c=2;c<i;c++)o[c]=n[c];return r.a.createElement.apply(null,o)}return r.a.createElement.apply(null,n)}p.displayName="MDXCreateElement"}}]);